# Week Start Date Fix Summary

## 問題の概要
本日ランキングに登録した書籍が09-01週の書籍であるにも関わらず、`week_start_date`が08-25になってしまい、フロントエンドに反映されていない問題を修正しました。

## 原因
9月1日（日曜日）に書籍を登録した際、従来の週計算ロジックでは日曜日を**前の週**に属するものとして扱っていたため、以下の問題が発生していました：

- 9月1日（日曜日）に登録 → week_start_date = 2024-08-26（前週の月曜日）
- 本来期待される値 → week_start_date = 2024-09-02（翌週の月曜日）

## 修正内容

### 1. フロントエンド修正

#### `/src/utils/dateUtils.ts` (新規作成)
週開始日計算の統一ロジックを提供する関数を作成：
- `getWeekStartDate()`: 日曜日を翌週の開始週として扱う週計算
- `getWeekStartDateForRegistration()`: 書籍登録時の週開始日計算

#### `/src/app/admin/rankings/page.tsx`
- 週計算ロジックを修正（行164-167）
- 新しいユーティリティ関数を使用するように変更

#### `/src/components/RankingSlider.tsx`
- 週計算ロジックを修正（行27-30）
- 新しいユーティリティ関数を使用するように変更

### 2. データベース修正

#### `/supabase/fix_week_calculation.sql` (新規作成)
- PostgreSQL関数 `get_week_start_date()` を修正
- 既存の間違ったweek_start_dateを持つレコードを自動修正

## 修正後の動作

### 週計算ロジック（修正後）
- **日曜日**: 翌日（月曜日）を週の開始日とする
- **月曜日〜土曜日**: その週の月曜日を週の開始日とする

### 具体例
- 2024-09-01（日曜日）に登録 → week_start_date = 2024-09-02
- 2024-09-02（月曜日）に登録 → week_start_date = 2024-09-02
- 2024-09-03（火曜日）に登録 → week_start_date = 2024-09-02

## 適用方法

### 1. フロントエンド
既にコードが修正済みです。次回のデプロイで反映されます。

### 2. データベース
以下のSQLファイルを実行してください：
```bash
# Supabaseで以下のSQLを実行
psql -f /workspace/supabase/fix_week_calculation.sql
```

## 検証方法

1. 管理画面（`/admin/rankings`）で現在の週開始日が正しく表示されることを確認
2. 日曜日に書籍を登録した場合、翌週の月曜日がweek_start_dateになることを確認
3. フロントエンドのランキングスライダーで正しい週の書籍が表示されることを確認

## 影響範囲
- ランキング書籍の管理画面
- フロントエンドのランキング表示
- 日曜日に登録される全ての書籍の週分類

この修正により、日曜日に登録された書籍が正しい週に分類され、フロントエンドに適切に反映されるようになります。