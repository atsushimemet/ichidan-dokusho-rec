# 📊 レコメンドロジック設計書

## 概要

質問ベースの書籍レコメンドシステムにおける、ユーザーの回答から最適な書籍を選出するためのスコアリングロジックについて説明します。

## 基本方針

### スコア算出の構成要素
1. **目的マッチング** (40%の重み)
2. **ジャンルマッチング** (40%の重み)  
3. **難易度マッチング** (20%の重み)

**総合スコア = (目的スコア × 0.4) + (ジャンルスコア × 0.4) + (難易度スコア × 0.2)**

---

## 質問項目とマッピング

### 質問1: 読書の目的

#### 選択肢とマッピング

| 目的 | value | 対応ジャンルタグ |
|------|-------|------------------|
| 知識・教養を身につけたい | `knowledge` | 教養, 歴史, 哲学, 科学, 社会問題, 人類学 |
| スキルアップしたい | `skill` | ビジネス, スキルアップ, プレゼンテーション, データ分析, 統計 |
| 自己成長したい | `growth` | 自己啓発, 成功法則, 習慣, 人生論, アドラー心理学, 心理学 |
| リラックス・娯楽 | `relaxation` | 小説, マンガ, エンタメ, 文学 |

#### スコア計算方式

```typescript
const purposeMapping: Record<string, string[]> = {
  knowledge: ['教養', '歴史', '哲学', '科学', '社会問題', '人類学'],
  skill: ['ビジネス', 'スキルアップ', 'プレゼンテーション', 'データ分析', '統計'],
  growth: ['自己啓発', '成功法則', '習慣', '人生論', 'アドラー心理学', '心理学'],
  relaxation: ['小説', 'マンガ', 'エンタメ', '文学']
};

// スコア = (一致したタグ数 / 関連タグ総数) × 100
// 最大値: 100, 最小値: 0
```

**例**: 
- 目的が`growth`で書籍タグが`['自己啓発', 'ビジネス', 'コミュニケーション']`の場合
- 関連タグ: `['自己啓発', '成功法則', '習慣', '人生論', 'アドラー心理学', '心理学']`
- 一致: `['自己啓発']` = 1個
- スコア: `1/6 ≈ 0.167 → 16.7点`

---

### 質問2: 興味のあるジャンル（複数選択可）

#### 選択肢一覧

| ジャンル | value | 説明 |
|----------|-------|------|
| 自己啓発 | `自己啓発` | 成功法則、習慣形成、モチベーション |
| ビジネス・経済 | `ビジネス` | 経営、マーケティング、投資 |
| 心理学 | `心理学` | 人間心理、コミュニケーション |
| 哲学・思想 | `哲学` | 人生論、価値観、思考法 |
| 歴史・社会 | `歴史` | 世界史、日本史、社会問題 |
| 科学・技術 | `科学` | IT、テクノロジー、自然科学 |
| 健康・ライフスタイル | `健康` | 健康法、料理、ライフハック |
| 小説・文学 | `小説` | 純文学、エンタメ小説 |

#### スコア計算方式

```typescript
// スコア = (一致したタグ数 / 選択したジャンル数) × 100
// 最大値: 100, 最小値: 0
// 選択なしの場合はデフォルト50点
```

**例**:
- 選択ジャンル: `['自己啓発', 'ビジネス']`
- 書籍タグ: `['自己啓発', 'コミュニケーション', 'ビジネス']`
- 一致: `['自己啓発', 'ビジネス']` = 2個
- スコア: `2/2 = 1.0 → 100点`

---

### 質問3: 読みやすさの希望

#### 選択肢とスコアリング

| 難易度 | value | 説明 | 完全一致スコア | 1段階差スコア | 2段階差スコア |
|--------|-------|------|----------------|---------------|---------------|
| 読みやすい本 | `beginner` | 初心者向け、分かりやすい表現 | 100 | 60 | 20 |
| 標準的な本 | `intermediate` | ある程度の読書経験が必要 | 100 | 60 | 20 |
| 専門的な本 | `advanced` | 深い内容、高度な議論 | 100 | 60 | 20 |

#### スコア計算方式

```typescript
const difficultyOrder = ['beginner', 'intermediate', 'advanced'];
const bookIndex = difficultyOrder.indexOf(book.difficulty_level);
const prefIndex = difficultyOrder.indexOf(preferredDifficulty);
const diff = Math.abs(bookIndex - prefIndex);

if (diff === 0) return 100;  // 完全一致
if (diff === 1) return 60;   // 1段階違い
if (diff === 2) return 20;   // 2段階違い
```

**例**:
- 希望: `intermediate`（中級）
- 書籍: `beginner`（初級）
- 差: `|1 - 0| = 1段階` → 60点

---

## マッチ理由の生成

ユーザーにレコメンド理由を表示するため、以下のロジックで理由を生成します。

### 理由の種類

#### 1. 目的の一致
```typescript
const purposeMapping: Record<string, string> = {
  knowledge: '知識・教養が身につく',
  skill: 'スキルアップに役立つ',
  growth: '自己成長につながる',
  relaxation: 'リラックスして読める'
};
```

#### 2. ジャンルの一致
```typescript
// 一致したジャンルタグから最大2個を表示
// 例: "自己啓発・ビジネス分野"
```

#### 3. 難易度の一致
```typescript
const difficultyMapping: Record<string, string> = {
  beginner: '読みやすく理解しやすい',
  intermediate: 'バランスの取れた内容',
  advanced: '専門的で深い内容'
};
```

### 表示ルール
- 最大3つの理由まで表示
- 優先順位: 目的 > ジャンル > 難易度

---

## 実装例

### コード構造

```typescript
class RecommendationEngine {
  static calculateScore(book: Book, responses: QuestionResponse): number {
    let score = 0;
    
    // 1. 目的スコア (40%)
    const purposeScore = this.getPurposeScore(book, responses.purpose);
    score += purposeScore * 0.4;
    
    // 2. ジャンルスコア (40%)
    const genreScore = this.getGenreScore(book, responses.genre_preference);
    score += genreScore * 0.4;
    
    // 3. 難易度スコア (20%)
    const difficultyScore = this.getDifficultyScore(book, responses.difficulty_preference);
    score += difficultyScore * 0.2;
    
    return Math.round(score * 100) / 100;
  }
}
```

### 具体的な計算例

**ユーザー回答**:
- 目的: `growth`（自己成長）
- ジャンル: `['自己啓発', '心理学']`
- 難易度: `beginner`

**書籍データ**:
- タイトル: "人を動かす"
- ジャンルタグ: `['自己啓発', 'コミュニケーション', 'ビジネス']`
- 難易度: `beginner`

**スコア計算**:

1. **目的スコア**:
   - 関連タグ: `['自己啓発', '成功法則', '習慣', '人生論', 'アドラー心理学', '心理学']`
   - 一致: `['自己啓発']` = 1個
   - スコア: `1/6 ≈ 16.7点`

2. **ジャンルスコア**:
   - 選択: `['自己啓発', '心理学']`
   - 書籍タグ: `['自己啓発', 'コミュニケーション', 'ビジネス']`
   - 一致: `['自己啓発']` = 1個
   - スコア: `1/2 = 50.0点`

3. **難易度スコア**:
   - 希望: `beginner`, 書籍: `beginner`
   - 完全一致: `100点`

**総合スコア**:
`(16.7 × 0.4) + (50.0 × 0.4) + (100 × 0.2) = 6.68 + 20.0 + 20.0 = 46.68点`

**マッチ理由**:
- "自己成長につながる"
- "自己啓発分野" 
- "読みやすく理解しやすい"

---

## 改善案・拡張可能性

### 短期的改善
1. **タグの重み付け**: ジャンルタグに重要度を設定
2. **読書時間考慮**: ユーザーの希望読書時間との適合性
3. **著者の専門性**: 著者の権威性や専門性を加味

### 長期的拡張
1. **ユーザー行動学習**: クリック率、購入率による動的重み調整
2. **協調フィルタリング**: 類似ユーザーの評価を参考
3. **コンテンツベース**: 書籍の内容分析によるより精密なマッチング
4. **多様性考慮**: 似たような書籍ばかりにならないよう多様性を確保

### パフォーマンス最適化
1. **スコア事前計算**: 人気の組み合わせは事前計算してキャッシュ
2. **インデックス最適化**: ジャンルタグや難易度でのクエリ最適化
3. **段階的読み込み**: 上位候補のみ詳細スコア計算

---

## まとめ

本レコメンドシステムは、シンプルながら効果的なスコアリングロジックにより、ユーザーの嗜好に合った書籍を推薦します。3つの観点からの総合評価により、バランスの取れたレコメンドを実現しています。

今後のデータ蓄積とユーザーフィードバックにより、継続的な改善を行うことで、より精度の高いレコメンドシステムへと発展させることができます。